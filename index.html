<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数学练习应用</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
        }
        select, input, button, textarea {
            font-size: 16px;
            margin: 10px;
            padding: 5px;
        }
        #questionDisplay {
            font-size: 24px;
            margin: 20px 0;
        }
        #result, #wrongQuestions, #mistakeListDisplay {
            margin-top: 20px;
            text-align: left;
        }
        #timer, #remaining {
            font-size: 18px;
            font-weight: bold;
            margin: 10px 0;
        }
        #answer {
            font-size: 24px;
            padding: 10px;
            width: 200px;
            text-align: center;
        }
        #progressBar {
            height: 20px;
            width: 100%;
            background-color: #ccc;
            margin-bottom: 10px;
        }
        #progress {
            height: 100%;
            background-color: green;
            width: 100%;
        }
        #pauseButton {
            margin: 10px;
            padding: 5px 10px;
        }
        #customQuestionsContainer {
            display: none;
            margin-top: 20px;
        }
        #customQuestions {
            width: 100%;
            height: 150px;
        }
        #mistakeTypeContainer {
            display: none;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>数学练习应用</h1>
    <div id="setup">
        <select id="practiceMode">
            <option value="regular">常规练习</option>
            <option value="wrong">错题练习</option>
            <option value="custom">自定义练习</option>
            <option value="mistakeList">错题清单</option>
        </select>
        <select id="practiceType">
            <option value="1">进位加法</option>
            <option value="2">退位减法</option>
            <option value="3">加减随机</option>
        </select>
        <input type="number" id="difficulty" placeholder="每题时间（秒）" min="1" value="5">
        <input type="number" id="numQuestions" placeholder="题目数量" min="1" value="20">
        <button onclick="startPractice()">开始练习</button>
        <button onclick="resetPractice()">重置本轮</button>
        <div id="customQuestionsContainer">
            <h3>输入自定义题目（每行一题，格式如：13 - 6 =）</h3>
            <textarea id="customQuestions"></textarea>
        </div>
        <div id="mistakeTypeContainer">
            <h3>选择要查看的错题类型：</h3>
            <select id="mistakeTypeSelect">
                <option value="all">全部错题</option>
                <option value="1">进位加法</option>
                <option value="2">退位减法</option>
                <option value="3">加减随机</option>
            </select>
            <button onclick="showMistakeList()">查看错题清单</button>
        </div>
    </div>
    <div id="practice" style="display: none;">
        <div id="timer"></div>
        <div id="remaining"></div>
        <div id="progressBar"><div id="progress"></div></div>
        <div id="questionDisplay"></div>
        <input type="number" id="answer" placeholder="请输入答案" inputmode="numeric" pattern="[0-9]*">
        <div>
            <button id="pauseButton" onclick="togglePause()">暂停</button>
        </div>
    </div>
    <div id="result"></div>
    <div id="wrongQuestions"></div>
    <div id="mistakeListDisplay"></div>

    <script>
        let currentQuestion, correctAnswer, questionCount, correctCount, wrongQuestions;
        let startTime, timeLimit, timerInterval, progressInterval;
        let allWrongQuestions = JSON.parse(localStorage.getItem('allWrongQuestions')) || [];
        let totalQuestions, score, practiceMode, isPaused = false;
        let questionSet = new Set();
        let pausedTime;
        let highestScore = parseInt(localStorage.getItem('highestScore')) || 0;

        document.getElementById('practiceMode').addEventListener('change', function() {
            const mode = this.value;
            if (mode === 'custom') {
                document.getElementById('customQuestionsContainer').style.display = 'block';
                document.getElementById('practiceType').style.display = 'none';
                document.getElementById('numQuestions').style.display = 'none';
                document.getElementById('mistakeTypeContainer').style.display = 'none';
            } else if (mode === 'mistakeList') {
                document.getElementById('mistakeTypeContainer').style.display = 'block';
                document.getElementById('customQuestionsContainer').style.display = 'none';
                document.getElementById('practiceType').style.display = 'none';
                document.getElementById('numQuestions').style.display = 'none';
                document.getElementById('difficulty').style.display = 'none';
            } else {
                document.getElementById('customQuestionsContainer').style.display = 'none';
                document.getElementById('mistakeTypeContainer').style.display = 'none';
                document.getElementById('practiceType').style.display = 'inline';
                document.getElementById('numQuestions').style.display = 'inline';
                document.getElementById('difficulty').style.display = 'inline';
            }
        });

        function generateQuestion(type, isWrongQuestion = false) {
            if (isWrongQuestion && allWrongQuestions.length > 0) {
                const filteredWrongQuestions = allWrongQuestions.filter(q => q.type === type);
                if (filteredWrongQuestions.length > 0) {
                    const randomIndex = Math.floor(Math.random() * filteredWrongQuestions.length);
                    const wrongQuestion = filteredWrongQuestions[randomIndex];
                    return { question: wrongQuestion.question, answer: wrongQuestion.answer, type: wrongQuestion.type };
                }
            }

            let a, b, question, answer;
            let maxAttempts = 100;
            while (maxAttempts > 0) {
                switch (parseInt(type)) {
                    case 1: // 进位加法
                        do {
                            a = Math.floor(Math.random() * 9) + 1;
                            b = Math.floor(Math.random() * 9) + 1;
                        } while (a + b < 11 || a + b === 10 || questionSet.has(`${a} + ${b} = ?`));
                        question = `${a} + ${b} = ?`;
                        answer = a + b;
                        break;
                    case 2: // 退位减法
                        a = Math.floor(Math.random() * 9) + 11; // 11到19之间的数
                        do {
                            b = Math.floor(Math.random() * 9) + 1;
                        } while (a - b >= 10 || a - b === 10 || questionSet.has(`${a} - ${b} = ?`));
                        question = `${a} - ${b} = ?`;
                        answer = a - b;
                        break;
                    case 3: // 加减随机
                        if (Math.random() < 0.5) {
                            ({ question, answer } = generateQuestion(1));
                        } else {
                            ({ question, answer } = generateQuestion(2));
                        }
                        break;
                }
                if (!questionSet.has(question)) {
                    questionSet.add(question);
                    break;
                }
                maxAttempts--;
            }
            return { question, answer, type };
        }

        function startPractice() {
            practiceMode = document.getElementById('practiceMode').value;
            const practiceType = document.getElementById('practiceType').value;
            timeLimit = parseInt(document.getElementById('difficulty').value) * 1000;
            questionCount = parseInt(document.getElementById('numQuestions').value);
            totalQuestions = questionCount;
            correctCount = 0;
            score = 0;
            wrongQuestions = [];
            questionSet.clear();
            isPaused = false;
            document.getElementById('pauseButton').textContent = '暂停';

            document.getElementById('setup').style.display = 'none';
            document.getElementById('practice').style.display = 'block';
            document.getElementById('result').innerHTML = '';
            document.getElementById('wrongQuestions').innerHTML = '';
            document.getElementById('mistakeListDisplay').innerHTML = '';

            if (practiceMode === 'custom') {
                const customQuestionsText = document.getElementById('customQuestions').value.trim();
                if (!customQuestionsText) {
                    alert('请输入自定义题目！');
                    resetPractice();
                    return;
                }
                customQuestions = customQuestionsText.split('\n').map(line => {
                    line = line.trim();
                    if (line.endsWith('=')) {
                        line = line.slice(0, -1).trim();
                    }
                    const operator = line.includes('+') ? '+' : line.includes('-') ? '-' : null;
                    if (!operator) {
                        alert('题目格式错误，请检查！');
                        resetPractice();
                        return;
                    }
                    const [aStr, bStr] = line.split(operator).map(s => s.trim());
                    const a = parseInt(aStr);
                    const b = parseInt(bStr);
                    if (isNaN(a) || isNaN(b)) {
                        alert('题目格式错误，请检查！');
                        resetPractice();
                        return;
                    }
                    let answer;
                    if (operator === '+') {
                        answer = a + b;
                    } else if (operator === '-') {
                        answer = a - b;
                    }
                    return { question: `${a} ${operator} ${b} = ?`, answer };
                }).filter(q => q);
                totalQuestions = customQuestions.length;
                questionCount = totalQuestions;
                nextCustomQuestion();
            } else if (practiceMode === 'mistakeList') {
                showMistakeList();
            } else {
                nextQuestion(practiceMode === 'wrong');
            }
        }

        function nextQuestion(isWrongQuestion) {
            clearInterval(timerInterval);
            clearInterval(progressInterval);

            if (questionCount > 0) {
                const practiceType = document.getElementById('practiceType').value;
                const { question, answer, type } = generateQuestion(practiceType, isWrongQuestion);
                currentQuestion = question;
                correctAnswer = answer;
                currentType = type;
                document.getElementById('questionDisplay').textContent = question;
                document.getElementById('answer').value = '';
                document.getElementById('answer').focus();
                document.getElementById('remaining').textContent = `剩余题目：${questionCount} / ${totalQuestions}`;
                startTime = Date.now();
                questionCount--;
                startTimer();
                startProgressBar();
            } else {
                endPractice();
            }
        }

        function nextCustomQuestion() {
            clearInterval(timerInterval);
            clearInterval(progressInterval);

            if (questionCount > 0) {
                const current = customQuestions[totalQuestions - questionCount];
                currentQuestion = current.question;
                correctAnswer = current.answer;
                document.getElementById('questionDisplay').textContent = currentQuestion;
                document.getElementById('answer').value = '';
                document.getElementById('answer').focus();
                document.getElementById('remaining').textContent = `剩余题目：${questionCount} / ${totalQuestions}`;
                startTime = Date.now();
                questionCount--;
                startTimer();
                startProgressBar();
            } else {
                endPractice();
            }
        }

        function startTimer() {
            const timerDisplay = document.getElementById('timer');
            timerInterval = setInterval(() => {
                if (!isPaused) {
                    const elapsed = Date.now() - startTime;
                    const remainingTime = Math.max(0, Math.ceil((timeLimit - elapsed) / 1000));
                    timerDisplay.textContent = `剩余时间：${remainingTime}秒`;
                    if (remainingTime <= 0) {
                        clearInterval(timerInterval);
                        submitAnswer();
                    }
                }
            }, 100);
        }

        function startProgressBar() {
            const progressBar = document.getElementById('progress');
            progressBar.style.width = '100%';
            const totalWidth = 100;
            const decrement = totalWidth / (timeLimit / 100);
            let width = totalWidth;
            progressInterval = setInterval(() => {
                if (!isPaused) {
                    width -= decrement;
                    if (width <= 0) {
                        width = 0;
                        clearInterval(progressInterval);
                    }
                    progressBar.style.width = `${width}%`;
                }
            }, 100);
        }

        function submitAnswer() {
            clearInterval(timerInterval);
            clearInterval(progressInterval);
            const userAnswer = parseInt(document.getElementById('answer').value);
            const responseTime = (Date.now() - startTime) / 1000;
            let points;
            if (responseTime <= 1) {
                points = 10;
            } else if (responseTime <= 2) {
                points = 8;
            } else if (responseTime <= 3) {
                points = 7;
            } else if (responseTime <= 4) {
                points = 6;
            } else {
                points = 5;
            }

            if (userAnswer === correctAnswer) {
                correctCount++;
                score += points;
            } else {
                wrongQuestions.push({ question: currentQuestion, type: currentType });
                if (!allWrongQuestions.some(q => q.question === currentQuestion)) {
                    allWrongQuestions.push({ question: currentQuestion, answer: correctAnswer, type: currentType });
                    localStorage.setItem('allWrongQuestions', JSON.stringify(allWrongQuestions));
                }
            }

            if (practiceMode === 'custom') {
                nextCustomQuestion();
            } else {
                nextQuestion(practiceMode === 'wrong');
            }
        }

        document.getElementById('answer').addEventListener('keyup', function(event) {
            if (event.key === 'Enter') {
                submitAnswer();
            }
        });

        function endPractice() {
            clearInterval(timerInterval);
            clearInterval(progressInterval);
            document.getElementById('practice').style.display = 'none';
            document.getElementById('setup').style.display = 'block';

            const accuracy = (correctCount / totalQuestions) * 100;

            if (score > highestScore) {
                highestScore = score;
                localStorage.setItem('highestScore', highestScore);
            }

            document.getElementById('result').innerHTML = `
                <h2>练习结束</h2>
                <p style="font-size: 32px;">总积分: ${score}</p>
                <p style="font-size: 24px;">最高记录: ${highestScore}</p>
                <p style="font-size: 24px;">正确率: ${accuracy.toFixed(2)}%</p>
            `;

            if (wrongQuestions.length > 0) {
                let wrongQuestionsHtml = '<h3>本次练习错误的题目:</h3><ul>';
                wrongQuestions.forEach(q => {
                    wrongQuestionsHtml += `<li>${q.question.replace('= ?', '')}</li>`;
                });
                wrongQuestionsHtml += '</ul>';
                document.getElementById('wrongQuestions').innerHTML = wrongQuestionsHtml;
            } else {
                document.getElementById('wrongQuestions').innerHTML = '<p>本次练习全对，做得不错！</p>';
            }

            // 添加清空错题库的按钮
            if (allWrongQuestions.length > 0 && practiceMode !== 'custom') {
                document.getElementById('wrongQuestions').innerHTML += `
                    <button onclick="clearWrongQuestions()">清空当前题型的错题库</button>
                `;
            }
        }

        function resetPractice() {
            // 不记录本轮错题，重新开始练习
            wrongQuestions = [];
            questionSet.clear();
            clearInterval(timerInterval);
            clearInterval(progressInterval);
            document.getElementById('practice').style.display = 'none';
            document.getElementById('setup').style.display = 'block';
        }

        function clearWrongQuestions() {
            const practiceType = document.getElementById('practiceType').value;
            allWrongQuestions = allWrongQuestions.filter(q => q.type !== practiceType);
            localStorage.setItem('allWrongQuestions', JSON.stringify(allWrongQuestions));
            alert('已清空当前题型的错题库');
        }

        function togglePause() {
            if (!isPaused) {
                isPaused = true;
                pausedTime = Date.now();
                document.getElementById('pauseButton').textContent = '恢复';
            } else {
                isPaused = false;
                // 调整开始时间以补偿暂停的时间
                startTime += Date.now() - pausedTime;
                document.getElementById('pauseButton').textContent = '暂停';
            }
        }

        function showMistakeList() {
            const mistakeType = document.getElementById('mistakeTypeSelect').value;
            let filteredMistakes;
            if (mistakeType === 'all') {
                filteredMistakes = allWrongQuestions;
            } else {
                filteredMistakes = allWrongQuestions.filter(q => q.type == mistakeType);
            }

            if (filteredMistakes.length === 0) {
                document.getElementById('mistakeListDisplay').innerHTML = '<p>没有对应的错题。</p>';
            } else {
                let listHtml = '<h3>错题清单:</h3><ul>';
                filteredMistakes.forEach(q => {
                    listHtml += `<li>${q.question.replace('= ?', '')}</li>`;
                });
                listHtml += '</ul>';
                document.getElementById('mistakeListDisplay').innerHTML = listHtml;
            }
        }
    </script>
</body>
</html>
